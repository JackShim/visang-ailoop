<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Market - Community</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script>
        window.JSONBIN_MASTER_KEY = '$2a$10$GZlQMTTQEqxm2tbjjvoq0uyZDVbgZ35Lmrl1er6FZEqzC4mGADLUG';
        window.JSONBIN_BIN_ID = localStorage.getItem('jsonbin_bin_id') || null;
    </script>
    
    <style>
        :root {
            --primary-color: #6a71f6;
            --secondary-color: #00b5e2;
            --bg-color: #ffffff;
            --text-main: #2b2b2b;
            --text-sub: #666666;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: auto; min-height: auto; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg-color); min-height: auto; padding: 20px; color: var(--text-main); position: relative; overflow-x: hidden; }
        body::before { content: ''; position: fixed; top: -20%; right: -10%; width: 800px; height: 800px; background: radial-gradient(circle, rgba(106, 113, 246, 0.15) 0%, transparent 70%); filter: blur(60px); border-radius: 50%; z-index: -1; animation: float 20s ease-in-out infinite; }
        body::after { content: ''; position: fixed; bottom: -20%; left: -10%; width: 700px; height: 700px; background: radial-gradient(circle, rgba(0, 181, 226, 0.15) 0%, transparent 70%); filter: blur(60px); border-radius: 50%; z-index: -1; animation: float 15s ease-in-out infinite reverse; }
        @keyframes float { 0%, 100% { transform: translate(0, 0) rotate(0deg); } 50% { transform: translate(30px, -30px) rotate(5deg); } }
        .container { max-width: 1200px; margin: 0 auto; position: relative; z-index: 1; display: flex; gap: 30px; padding-top: 80px; }
        .gnb { position: fixed; top: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 1000; padding: 15px 0; transition: all 0.3s ease; }
        .gnb-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .gnb-logo { font-size: 24px; font-weight: 900; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; letter-spacing: -0.5px; }
        .gnb-nav { display: flex; gap: 10px; }
        .gnb-nav a { padding: 8px 16px; text-decoration: none; color: var(--text-sub); font-size: 16px; font-weight: 500; border-radius: 8px; transition: all 0.2s; }
        .gnb-nav a:hover { background: rgba(0,0,0,0.03); color: var(--text-main); }
        .gnb-nav a.active { color: var(--primary-color); background: rgba(106, 113, 246, 0.05); font-weight: 700; }
        .lnb { width: 260px; flex-shrink: 0; position: sticky; top: 100px; height: fit-content; }
        .lnb-content { background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 24px; padding: 24px; box-shadow: var(--glass-shadow); }
        .lnb-title { font-size: 14px; font-weight: 700; color: #888; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; padding-left: 10px; }
        .lnb-menu { list-style: none; }
        .lnb-menu li { margin-bottom: 4px; }
        .lnb-menu a { display: flex; align-items: center; padding: 12px 16px; text-decoration: none; color: var(--text-main); font-size: 16px; border-radius: 12px; transition: all 0.2s ease; font-weight: 500; }
        .lnb-menu a:hover { background: rgba(0,0,0,0.03); transform: translateX(4px); }
        .lnb-menu a.active { background: linear-gradient(90deg, rgba(106, 113, 246, 0.1), rgba(0, 181, 226, 0.1)); color: var(--primary-color); font-weight: 700; }
        .main-content { flex: 1; min-width: 0; }
        header { text-align: center; margin-bottom: 20px; padding: 10px 0; position: relative; }
        h1 { font-size: 48px; font-weight: 900; margin-bottom: 5px; background: linear-gradient(135deg, #2b2b2b 0%, #555 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -2px; }
        h1 span { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { font-size: 18px; color: var(--text-sub); max-width: 600px; margin: 0 auto; line-height: 1.6; }
        .search-container { margin-bottom: 15px; position: relative; z-index: 10; }
        .search-box { display: flex; gap: 12px; background: white; padding: 8px; border-radius: 18px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto; }
        .search-input { flex: 1; padding: 12px 24px; border: none; font-size: 16px; font-family: 'Noto Sans KR', sans-serif; background: transparent; color: var(--text-main); }
        .search-input:focus { outline: none; }
        .btn { padding: 12px 24px; border: none; border-radius: 14px; font-size: 16px; font-family: 'Noto Sans KR', sans-serif; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); white-space: nowrap; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; box-shadow: 0 4px 15px rgba(106, 113, 246, 0.3); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(106, 113, 246, 0.4); filter: brightness(1.1); }
        .btn-secondary { background: white; color: var(--text-main); border: 1px solid #e0e0e0; }
        .btn-secondary:hover:not(:disabled) { background: #f8f9fa; border-color: #d0d0d0; transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .filter-group { display: flex; gap: 10px; }
        .filter-chip { padding: 8px 16px; border-radius: 20px; font-size: 14px; cursor: pointer; background: white; border: 1px solid #eee; color: var(--text-sub); transition: all 0.2s; }
        .filter-chip.active { background: rgba(106, 113, 246, 0.1); color: var(--primary-color); border-color: var(--primary-color); font-weight: 600; }
        .posts-container { display: flex; flex-direction: column; gap: 20px; }
        .post-card { background: white; border-radius: 20px; padding: 20px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; box-shadow: 0 4px 20px rgba(0,0,0,0.03); position: relative; overflow: hidden; }
        .post-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color)); opacity: 0; transition: opacity 0.3s; }
        .post-card:hover { transform: translateY(-4px); box-shadow: 0 12px 40px rgba(106, 113, 246, 0.15); border-color: rgba(106, 113, 246, 0.2); }
        .post-card:hover::before { opacity: 1; }
        .post-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .post-title { font-size: 20px; font-weight: 700; color: var(--text-main); margin-bottom: 8px; line-height: 1.4; }
        .post-meta { display: flex; gap: 12px; font-size: 13px; color: var(--text-sub); align-items: center; }
        .post-category { background: rgba(106, 113, 246, 0.1); color: var(--primary-color); padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 12px; }
        .post-content-preview { font-size: 16px; color: #555; line-height: 1.6; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .post-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f0f0f0; padding-top: 10px; margin-top: 5px; }
        .post-author { font-size: 14px; font-weight: 500; color: var(--text-main); display: flex; align-items: center; gap: 6px; }
        .author-avatar { width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(135deg, #e0e0e0, #f5f5f5); }
        .post-stats { display: flex; gap: 15px; font-size: 13px; color: var(--text-sub); }
        .stat-item { display: flex; align-items: center; gap: 4px; }
        .section-title { font-size: 22px; color: var(--text-main); margin-bottom: 20px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .top-posts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .top-post-card { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; border: 1px solid transparent; }
        .top-post-card:hover { transform: translateY(-4px); border-color: var(--secondary-color); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px); z-index: 2000; justify-content: center; align-items: center; padding: 20px; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal { background: white; border-radius: 24px; padding: 40px; max-width: 650px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 80px rgba(0, 0, 0, 0.2); transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .modal-title { font-size: 24px; color: var(--text-main); font-weight: 800; }
        .close-btn { background: none; border: none; font-size: 28px; color: #999; cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: var(--text-main); }
        .form-group { margin-bottom: 24px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-main); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 14px; border: 2px solid #f0f0f0; border-radius: 12px; font-size: 16px; font-family: 'Noto Sans KR', sans-serif; transition: all 0.2s; background: #fcfcfc; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-color); background: white; box-shadow: 0 0 0 4px rgba(106, 113, 246, 0.1); }
        .form-textarea { min-height: 150px !important; resize: vertical; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 30px; }
        .post-detail { background: white; border-radius: 24px; padding: 40px; box-shadow: var(--glass-shadow); }
        .detail-header { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .detail-title { font-size: 32px; font-weight: 800; color: var(--text-main); margin-bottom: 16px; line-height: 1.3; }
        .detail-content { font-size: 17px; line-height: 1.8; color: var(--text-main); white-space: pre-wrap; margin-bottom: 40px; }
        .loading { display: none; text-align: center; padding: 60px; }
        .loading.active { display: block; }
        .spinner { border: 3px solid rgba(106, 113, 246, 0.1); border-top: 3px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 80px 20px; color: var(--text-sub); font-size: 16px; background: white; border-radius: 20px; border: 1px dashed #ddd; }
        @media (max-width: 900px) {
            .container { flex-direction: column; padding-top: 70px; }
            .lnb { width: 100%; position: static; margin-bottom: 20px; }
            .lnb-menu { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px; }
            .lnb-menu li { margin-bottom: 0; }
            .lnb-menu a { white-space: nowrap; }
            .lnb-title, .lnb-category { display: none; }
            h1 { font-size: 40px; }
            .action-bar { flex-direction: column; gap: 15px; align-items: flex-start; }
            .filter-group { overflow-x: auto; width: 100%; padding-bottom: 5px; }
            .top-posts-grid { grid-template-columns: 1fr; }
            .modal { padding: 24px; }
        }
    </style>
</head>
<body>
    <nav class="gnb">
        <div class="gnb-content">
            <a href="#" class="gnb-logo" onclick="goToHome(); return false;">AI Market</a>
            <div class="gnb-nav">
                <a href="#" onclick="goToHome(); return false;">í™ˆ</a>
                <a href="#" class="active" onclick="return false;">ì»¤ë®¤ë‹ˆí‹°</a>
            </div>
        </div>
    </nav>
    <div class="container">
        <aside class="lnb">
            <div class="lnb-content">
                <h3 class="lnb-title">ë©”ë‰´</h3>
                <ul class="lnb-menu">
                    <li><a href="#" onclick="showAllPosts(); return false;" class="active">ì „ì²´ ê²Œì‹œê¸€</a></li>
                    <li><a href="#" onclick="showTopPosts(); return false;">ğŸ”¥ ì¸ê¸° ê²Œì‹œê¸€</a></li>
                    <li><a href="#" onclick="showCategoryPosts('ì§ˆë¬¸/ë‹µë³€'); return false;">ì§ˆë¬¸/ë‹µë³€</a></li>
                    <li><a href="#" onclick="showCategoryPosts('íŒ/ë…¸í•˜ìš°'); return false;">íŒ/ë…¸í•˜ìš°</a></li>
                    <li><a href="#" onclick="showCategoryPosts('ìë£Œê³µìœ '); return false;">ìë£Œê³µìœ </a></li>
                    <li><a href="#" onclick="showCategoryPosts('ì¼ìƒ/ë‰´ìŠ¤'); return false;">ì¼ìƒ/ë‰´ìŠ¤</a></li>
                </ul>
                <div id="tagCloudContainer" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0;">
                    <h3 class="lnb-title">ì£¼ìš” íƒœê·¸</h3>
                    <div id="tagCloud" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                </div>
            </div>
        </aside>
        <div class="main-content">
            <header id="mainHeader">
                <h1>AI Market <span>Community</span></h1>
                <p class="subtitle">ì§ˆë¬¸ê³¼ ë‹µë³€, ë…¸í•˜ìš°ë¥¼ ììœ ë¡­ê²Œ ê³µìœ í•˜ì„¸ìš”</p>
            </header>
            <div class="search-container" id="searchContainer">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="ë¬´ì—‡ì´ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?">
                    <button class="btn btn-primary" onclick="handleSearch()" style="border-radius: 12px; padding: 10px 20px;">ê²€ìƒ‰</button>
                </div>
            </div>
            <div class="top-posts-section" id="topPostsSection" style="display: none;">
                <h2 class="section-title">ğŸ”¥ ì¸ê¸° ê²Œì‹œê¸€</h2>
                <div id="topPostsGrid"></div>
            </div>
            <div id="featuredPostsSection" style="display: none; margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="section-title" style="margin-bottom: 0;">ğŸ”¥ ì¸ê¸° ê²Œì‹œê¸€</h2>
                    <a href="#" onclick="event.preventDefault(); showTopPosts();" style="text-decoration: none; color: var(--primary-color); font-weight: 600;">ë”ë³´ê¸° &gt;</a>
                </div>
                <div id="featuredPostsContainer" style="display: flex; overflow-x: auto; gap: 15px; padding: 10px 0; scroll-snap-type: x mandatory; -ms-overflow-style: none; scrollbar-width: none;"></div>
                <style>
                    #featuredPostsContainer::-webkit-scrollbar { display: none; }
                </style>
            </div>
            <div class="action-bar" id="actionBar">
                <div class="filter-group">
                    <span id="totalPostCount" style="font-size: 14px; color: var(--text-sub); white-space: nowrap; margin-right: 10px;">ì´ 0ê°œ</span>
                    <div class="filter-chip active" onclick="setSortOrder('latest')">ìµœì‹ ìˆœ</div>
                    <div class="filter-chip" onclick="setSortOrder('popular')">ì¸ê¸°ìˆœ</div>
                    <div class="filter-chip" onclick="setSortOrder('comments')">ëŒ“ê¸€ìˆœ</div>
                </div>
                <button class="btn btn-primary" id="newPostBtn" onclick="openNewPostModal()">+ ìƒˆ ê¸€ ì‘ì„±</button>
            </div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="color: #888;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
            <div class="posts-container" id="postsContainer">
                <div class="empty-state" id="emptyState">
                    <p style="font-size: 40px; margin-bottom: 20px;">ğŸ“­</p>
                    <p>ë“±ë¡ëœ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
                </div>
                <div id="postsList" style="display: flex; flex-direction: column; gap: 20px;"></div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="loadMoreBtn" class="btn btn-secondary" onclick="loadMorePosts()" style="display: none;">ë” ë³´ê¸°</button>
            </div>
            <div class="post-detail" id="postDetail" style="display: none;">
                <button class="btn btn-secondary" onclick="showAllPosts()" style="margin-bottom: 20px; padding: 8px 16px; font-size: 14px;">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                <div class="detail-header">
                    <div class="post-meta" id="detailMeta" style="margin-bottom: 10px;"></div>
                    <h2 class="detail-title" id="detailTitle"></h2>
                </div>
                <div class="detail-content" id="detailContent"></div>
                <div class="post-footer"></div>
                <div style="margin-top: 50px; padding-top: 30px; border-top: 1px dashed #ddd;">
                    <h3 class="section-title" style="font-size: 20px; margin-bottom: 20px;">ë‹µë³€ <span id="answerCountDisplay" style="color: var(--primary-color);">0</span></h3>
                    <div id="answersList" style="display: flex; flex-direction: column; gap: 20px; margin-bottom: 40px;"></div>
                    <div style="background: #f9f9f9; padding: 25px; border-radius: 20px;">
                        <h4 style="margin-bottom: 15px; font-weight: 700; font-size: 16px;">ë‹µë³€ ì‘ì„±í•˜ê¸°</h4>
                        <div class="form-group">
                            <textarea class="form-textarea" id="answerContent" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="4" style="min-height: 80px; background: white;"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 14px; font-weight: normal;">ë¹„ë°€ë²ˆí˜¸ (í•„ìˆ˜)</label>
                            <input type="password" id="answerPassword" class="form-input" style="padding: 10px;" placeholder="ë‹µë³€ ìˆ˜ì •/ì‚­ì œ ì‹œ í•„ìš”í•©ë‹ˆë‹¤">
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="answerAnonymous" style="width: 16px; height: 16px;">
                                <label for="answerAnonymous" style="font-size: 14px; cursor: pointer;">ìµëª…</label>
                            </div>
                            <button class="btn btn-primary" id="submitAnswerBtn" onclick="submitAnswer()">ë“±ë¡</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="newPostModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="postModalTitle">ìƒˆ ê¸€ ì‘ì„±</h2>
                <button class="close-btn" onclick="closeNewPostModal()">Ã—</button>
            </div>
            <form id="postForm">
                <div class="form-group">
                    <label class="form-label">ì¹´í…Œê³ ë¦¬ (í•„ìˆ˜)</label>
                    <select class="form-select" id="postCategory" required>
                        <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ì§ˆë¬¸/ë‹µë³€">ì§ˆë¬¸/ë‹µë³€</option>
                        <option value="íŒ/ë…¸í•˜ìš°">íŒ/ë…¸í•˜ìš°</option>
                        <option value="ìë£Œê³µìœ ">ìë£Œê³µìœ </option>
                        <option value="ì¼ìƒ/ë‰´ìŠ¤">ì¼ìƒ/ë‰´ìŠ¤</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ì œëª© (í•„ìˆ˜)</label>
                    <input type="text" class="form-input" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ë‚´ìš© (í•„ìˆ˜)</label>
                    <textarea class="form-textarea" id="postContent" placeholder="ë‚´ìš©ì„ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”" required></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">íƒœê·¸ (ì„ íƒ)</label>
                    <input type="text" class="form-input" id="postTags" placeholder="ì‰¼í‘œ(,)ë¡œ íƒœê·¸ë¥¼ êµ¬ë¶„í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: AI, íŒŒì´ì¬, ëª¨ë¸)">
                </div>
                <div class="form-group">
                    <label class="form-label">ì°¸ê³  ë§í¬ (ì„ íƒ)</label>
                    <input type="url" class="form-input" id="postLink" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">ë¹„ë°€ë²ˆí˜¸ (í•„ìˆ˜)</label>
                    <input type="password" class="form-input" id="postPassword" placeholder="ìˆ˜ì •/ì‚­ì œ ì‹œ í•„ìš”í•©ë‹ˆë‹¤">
                </div>
                <div class="form-group">
                    <label class="form-label">ì´ë¯¸ì§€ ì²¨ë¶€ (ì„ íƒ)</label>
                    <input type="file" id="postImages" accept="image/*" multiple style="display: none;" onchange="handleImageSelect(event)">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('postImages').click()" style="width: 100%; text-align: left; color: #666;">ğŸ“· ì´ë¯¸ì§€ ì„ íƒí•˜ê¸°</button>
                    <div id="imagePreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-top: 15px;"></div>
                </div>
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="postAnonymous" style="width: 18px; height: 18px;">
                        <label for="postAnonymous" style="font-size: 15px; cursor: pointer;">ìµëª…ìœ¼ë¡œ ê²Œì‹œ</label>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeNewPostModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ê²Œì‹œê¸€ ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-overlay" id="messageModal">
        <div class="modal" style="max-width: 400px; text-align: center;">
            <h2 class="modal-title" id="messageTitle" style="margin-bottom: 15px;">ì•Œë¦¼</h2>
            <p id="messageContent" style="font-size: 16px; margin-bottom: 30px; color: #666;"></p>
            <button class="btn btn-primary" onclick="closeMessageModal()" style="width: 100%;">í™•ì¸</button>
        </div>
    </div>
    <div class="modal-overlay" id="deleteConfirmModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">ê²Œì‹œê¸€ ì‚­ì œ</h2>
                <button class="close-btn" onclick="closeDeleteModal()">Ã—</button>
            </div>
            <p style="margin-bottom: 20px; color: #666;">ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <div class="form-group">
                <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" class="form-input" id="deletePassword">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="handleDeletePost()" style="background: #ff4d4d;">ì‚­ì œ í™•ì¸</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="editConfirmModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">ê²Œì‹œê¸€ ìˆ˜ì •</h2>
                <button class="close-btn" onclick="closeEditModal()">Ã—</button>
            </div>
            <p style="margin-bottom: 20px; color: #666;">ê²Œì‹œê¸€ì„ ìˆ˜ì •í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <div class="form-group">
                <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" class="form-input" id="editPassword">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="handleEditAuth()">í™•ì¸</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="deleteAnswerConfirmModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">ë‹µë³€ ì‚­ì œ</h2>
                <button class="close-btn" onclick="closeDeleteAnswerModal()">Ã—</button>
            </div>
            <p style="margin-bottom: 20px; color: #666;">ë‹µë³€ì„ ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <div class="form-group">
                <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" class="form-input" id="deleteAnswerPassword">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteAnswerModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="handleDeleteAnswer()" style="background: #ff4d4d;">ì‚­ì œ í™•ì¸</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="deleteReplyConfirmModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">ëŒ€ëŒ“ê¸€ ì‚­ì œ</h2>
                <button class="close-btn" onclick="closeDeleteReplyModal()">Ã—</button>
            </div>
            <p style="margin-bottom: 20px; color: #666;">ëŒ€ëŒ“ê¸€ì„ ì‚­ì œí•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <div class="form-group">
                <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" class="form-input" id="deleteReplyPassword">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteReplyModal()">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="handleDeleteReply()" style="background: #ff4d4d;">ì‚­ì œ í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        // Logic Section
        const JSONBIN_API_URL = 'https://api.jsonbin.io/v3/b';
        const JSONBIN_MASTER_KEY = window.JSONBIN_MASTER_KEY;
        let currentPostId = null;
        let selectedImages = [];
        let currentFilter = 'all';
        let currentCategory = null;
        let currentTag = null;
        let editModePostId = null;
        let currentAnswerIdToDelete = null;
        let likedItems = {};
        let currentSortOrder = 'latest';
        let postsPerPage = 10;
        let currentPage = 1;
        let activeReplyFormId = null;
        let currentReplyIdToDelete = null;
        let currentReplyParentId = null;

        function getUserId() {
            let userId = localStorage.getItem('anonymous_user_id');
            if (!userId) {
                userId = 'user_' + generateUUID().substring(0, 8);
                localStorage.setItem('anonymous_user_id', userId);
            }
            return userId;
        }

        // --- Data Functions ---
        async function createBin(data, binName = 'Post') {
            try {
                const response = await fetch(JSONBIN_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_MASTER_KEY,
                        'X-Bin-Name': binName
                    },
                    body: JSON.stringify(data)
                });
                if (response.ok) {
                    const result = await response.json();
                    return result.metadata.id;
                }
                throw new Error('Failed to create bin');
            } catch (error) {
                console.error('Error creating bin:', error);
                return null;
            }
        }
        
        async function updateBin(binId, data) {
            try {
                const response = await fetch(`${JSONBIN_API_URL}/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_MASTER_KEY
                    },
                    body: JSON.stringify(data)
                });
                return response.ok;
            } catch (error) {
                console.error('Error updating bin:', error);
                return false;
            }
        }

        async function getBin(binId) {
            if (!binId) return null;
            try {
                const response = await fetch(`${JSONBIN_API_URL}/${binId}/latest`, {
                    headers: { 'X-Master-Key': JSONBIN_MASTER_KEY }
                });
                if (response.ok) {
                    const result = await response.json();
                    return result.record;
                }
                return null;
            } catch (error) {
                console.error('Error getting bin:', error);
                return null;
            }
        }
        
        async function getOrCreateIndexBin() {
            let masterBinId = localStorage.getItem('master_bin_id');
            if (!masterBinId) {
                masterBinId = await createBin({ posts: [] }, 'Master Post Index');
                if (masterBinId) {
                    localStorage.setItem('master_bin_id', masterBinId);
                } else {
                    throw new Error("Could not create master index bin.");
                }
            }
            return masterBinId;
        }

        // --- End Data Functions ---

        function init() {
            likedItems = getLikedItems(); // Load liked items on init

            // ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì§€ì›
            const postContent = document.getElementById('postContent');
            if (postContent) {
                postContent.addEventListener('paste', handlePasteImages);
            }

            loadPosts();

            // ê³µìœ  ë§í¬ë¡œ ì ‘ê·¼ ì‹œ ë°”ë¡œ ì—´ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const sharedPostId = urlParams.get('postId');
            if (sharedPostId) {
                viewPost(sharedPostId);
            }

            // Attach dynamic event listener to the post form
            document.getElementById('postForm').addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent default form submission
                if (editModePostId) {
                    handleUpdatePost();
                } else {
                    submitPost();
                }
            });
        }

        function goToHome() {
             window.location.reload();
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        const anonColors = ['í•˜ëŠ˜', 'ë…¸ë‘', 'ë¶„í™', 'ë³´ë¼', 'ì´ˆë¡', 'ì£¼í™©', 'íšŒìƒ‰', 'ê²€ì •', 'í°ìƒ‰', 'íŒŒë‘'];
        const anonEmotions = ['í–‰ë³µí•œ', 'ìŠ¬í”ˆ', 'í™”ë‚œ', 'ì¦ê±°ìš´', 'ìš°ìš¸í•œ', 'ì‹ ë‚˜ëŠ”', 'ê³ ìš”í•œ', 'ìˆ˜ì¤ì€', 'ìš©ê°í•œ', 'í”¼ê³¤í•œ'];
        const anonAnimals = ['ê³ ì–‘ì´', 'ê°•ì•„ì§€', 'í˜¸ë‘ì´', 'ì‚¬ì', 'ì½”ë¼ë¦¬', 'ê¸°ë¦°', 'í•˜ë§ˆ', 'í† ë¼', 'ê±°ë¶ì´', 'ëŒê³ ë˜'];

        function generateAnonymousName() {
            const emotion = anonEmotions[Math.floor(Math.random() * anonEmotions.length)];
            const color = anonColors[Math.floor(Math.random() * anonColors.length)];
            const animal = anonAnimals[Math.floor(Math.random() * anonAnimals.length)];
            return `${emotion}${color}${animal}`;
        }

        function getYouTubeVideoId(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|shorts\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // --- Like Feature Helpers ---
        function getLikedItems() {
            try {
                const stored = localStorage.getItem('likedItems');
                return stored ? JSON.parse(stored) : {};
            } catch (e) {
                console.error("Error parsing likedItems from localStorage", e);
                return {};
            }
        }

        function setLikedItems(items) {
            try {
                localStorage.setItem('likedItems', JSON.stringify(items));
            } catch (e) {
                console.error("Error saving likedItems to localStorage", e);
            }
        }

        function isLiked(itemId) {
            return likedItems[itemId] === true;
        }

        function addLikedItem(itemId) {
            likedItems[itemId] = true;
            setLikedItems(likedItems);
        }

        function removeLikedItem(itemId) {
            delete likedItems[itemId];
            setLikedItems(likedItems);
        }

        async function handleLike(itemId, itemType) {
            const isCurrentlyLiked = isLiked(itemId);
            
            // --- Immediate UI Update ---
            // Find all buttons for this item (e.g., in main list and featured list)
            const likeButtons = document.querySelectorAll(`button[onclick="handleLike('${itemId}', '${itemType}')"]`);

            likeButtons.forEach(likeButton => {
                // Find the count span relative to this specific button's parent
                const countSpan = likeButton.parentElement.querySelector('.like-count');

                if (countSpan) {
                    let currentLikes = parseInt(countSpan.textContent) || 0;
                    if (isCurrentlyLiked) {
                        countSpan.textContent = Math.max(0, currentLikes - 1);
                        likeButton.innerHTML = 'ğŸ¤';
                        likeButton.style.color = '#bbb';
                    } else {
                        countSpan.textContent = currentLikes + 1;
                        likeButton.innerHTML = 'â¤ï¸';
                        likeButton.style.color = 'var(--primary-color)';
                    }
                }
            });

            // --- Background Data Sync ---
            if (isCurrentlyLiked) {
                removeLikedItem(itemId);
            } else {
                addLikedItem(itemId);
            }

            try {
                // When liking a comment/reply, we need the parent post's ID to fetch the correct bin.
                const postIdForAPI = (itemType === 'post') ? itemId : currentPostId;
                if (!postIdForAPI) return;

                const post = await getBin(postIdForAPI);
                if (!post) throw new Error("Post not found while handling like");

                let itemToUpdate = null;
                if (itemType === 'post') {
                    itemToUpdate = post;
                } else { // 'answer' or 'reply'
                     const findItemRecursive = (items, id) => {
                        for (const item of items) {
                            if (item.answerId === id) return item;
                            if (item.replies) {
                                const foundInReply = findItemRecursive(item.replies, id);
                                if (foundInReply) return foundInReply;
                            }
                        }
                        return null;
                    };
                    itemToUpdate = findItemRecursive(post.answers || [], itemId);
                }

                if (itemToUpdate) {
                    if (isCurrentlyLiked) {
                        itemToUpdate.likes = Math.max(0, (itemToUpdate.likes || 0) - 1);
                    } else {
                        itemToUpdate.likes = (itemToUpdate.likes || 0) + 1;
                    }
                    
                    // Save the entire post object back
                    await updateBin(postIdForAPI, post);

                    // If it was a post like, also update the master index for the list view
                    if (itemType === 'post') {
                         const masterBinId = await getOrCreateIndexBin();
                         const indexData = await getBin(masterBinId);
                         if(indexData && indexData.posts){
                            const postMetadata = indexData.posts.find(p => p.postId === postIdForAPI);
                            if (postMetadata) {
                                postMetadata.likes = itemToUpdate.likes;
                                await updateBin(masterBinId, indexData);
                            }
                         }
                    }
                }
            } catch (error) {
                console.error('Error syncing like:', error);
            }
        }
                // --- End Like Feature Helpers ---
        
                async function loadPosts(append = false) {
                    document.getElementById('loading').classList.add('active');
                    try {
                        const masterBinId = await getOrCreateIndexBin();
                        const indexData = await getBin(masterBinId);
                        let allPosts = (indexData && Array.isArray(indexData.posts)) ? indexData.posts : [];
                        
                        updateTagCloud(allPosts);
        
                        let filteredPosts = allPosts;
                        if (currentCategory) {
                            filteredPosts = filteredPosts.filter(post => post.category === currentCategory);
                        }
                        if (currentTag) {
                            filteredPosts = filteredPosts.filter(post => post.tags && post.tags.includes(currentTag));
                        }
                        
                        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
                        if(searchTerm){
                            filteredPosts = filteredPosts.filter(post => 
                                (post.title || '').toLowerCase().includes(searchTerm) ||
                                (post.contentPreview || '').toLowerCase().includes(searchTerm) ||
                                (post.tags || []).join(' ').toLowerCase().includes(searchTerm)
                            );
                        }
        
                        if (currentSortOrder === 'popular') {
                            filteredPosts.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                        } else if (currentSortOrder === 'comments') {
                            filteredPosts.sort((a, b) => (b.answerCount || 0) - (a.answerCount || 0));
                        } else { // 'latest'
                            filteredPosts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        }
        
                        const startIndex = append ? (currentPage - 1) * postsPerPage : 0;
                        const endIndex = currentPage * postsPerPage;
                        const postsToDisplay = filteredPosts.slice(startIndex, endIndex);
                        
                        const postsList = document.getElementById('postsList');
                        const emptyState = document.getElementById('emptyState');
                        const loadMoreBtn = document.getElementById('loadMoreBtn');
                        const totalPostCount = document.getElementById('totalPostCount');
        
                        if (totalPostCount) totalPostCount.textContent = `ì´ ${filteredPosts.length}ê°œ`;
        
                        if (!append) {
                            postsList.innerHTML = '';
                        }
        
                        if (filteredPosts.length === 0) {
                            emptyState.style.display = 'block';
                        } else {
                            emptyState.style.display = 'none';
                            displayPosts(postsToDisplay, postsList);
                        }
                        
                        if (filteredPosts.length > endIndex) {
                            loadMoreBtn.style.display = 'block';
                        } else {
                            loadMoreBtn.style.display = 'none';
                        }
        
                    } catch (error) {
                        console.error('Error loading posts:', error);
                        document.getElementById('emptyState').style.display = 'block';
                    } finally {
                        document.getElementById('loading').classList.remove('active');
                    }
                }
        
                function loadMorePosts() {
                    currentPage++;
                    loadPosts(true);
                }
        
                function displayPosts(posts, postsListElement) {
                    postsListElement.innerHTML += posts.map(post => {
                        let thumbnailHtml = '';
                        let imageUrl = '';
        
                        if (post.images && post.images.length > 0) {
                            imageUrl = post.images[0];
                        } else if (post.link) {
                            const videoId = getYouTubeVideoId(post.link);
                            if (videoId) {
                                imageUrl = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
                            }
                        }
        
                        if (imageUrl) {
                            thumbnailHtml = `
                                <div class="post-thumbnail" style="flex-shrink: 0; width: 120px; height: 90px; border-radius: 8px; overflow: hidden; margin-left: 20px; border: 1px solid #eee;">
                                    <img src="${escapeHtml(imageUrl)}" alt="Thumbnail" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                            `;
                        }
        
                        return `
                            <div class="post-card" onclick="viewPost('${post.postId}')" style="display: flex;">
                                <div style="flex: 1;">
                                    <div class="post-header">
                                        <div>
                                            <div class="post-title">${escapeHtml(post.title)}</div>
                                            <div class="post-meta">
                                                <span class="post-category">${escapeHtml(post.category || 'ê¸°íƒ€')}</span>
                                                <span>${formatDate(post.createdAt)}</span>
                                                ${post.updatedAt && new Date(post.updatedAt) > new Date(post.createdAt) ? `<span>(ìˆ˜ì •ë¨)</span>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="post-content-preview">${escapeHtml(post.contentPreview || '')}</div>
                                    ${ 
                                        post.tags && post.tags.length > 0
                                        ? `<div class="post-tags" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px;">
                                                ${post.tags.map(tag => `<span style="background: #f0f0f0; color: #555; padding: 4px 8px; border-radius: 6px; font-size: 12px;">#${escapeHtml(tag)}</span>`).join('')}
                                           </div>`
                                        : ''
                                    }
                                    <div class="post-footer" style="margin-top: 10px;">
                                        <span class="post-author">
                                            <div class="author-avatar"></div>
                                            ${escapeHtml(post.authorName || 'ìµëª…')}
                                        </span>
                                        <div class="post-stats">
                                            <span class="stat-item" style="color: #999;">ğŸ‘ï¸ ${post.views || 0}</span>
                                            <span class="stat-item like-section" style="display:flex; align-items:center; gap: 4px;">
                                                <button class="btn-like" onclick="event.stopPropagation(); handleLike('${post.postId}', 'post')" style="background:none; border:none; cursor:pointer; padding:0; font-size: 16px; color: ${isLiked(post.postId) ? 'var(--primary-color)' : '#bbb'};">
                                                    ${isLiked(post.postId) ? 'â¤ï¸' : 'ğŸ¤'}
                                                </button>
                                                <span class="like-count" style="font-weight: 600;">${post.likes || 0}</span>
                                            </span>
                                            <span class="stat-item" style="color: var(--secondary-color); font-weight: 600;">
                                                ğŸ’¬ ${post.answerCount || 0} ë‹µë³€
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                ${thumbnailHtml}
                            </div>
                        `;
                    }).join('');
                }
        
        
                function updateTagCloud(posts) {
                    const tagContainer = document.getElementById('tagCloud');
                    const tagCloudContainer = document.getElementById('tagCloudContainer');
                    if (!tagContainer || !tagCloudContainer) return;
        
                    const tagCounts = {};
                    posts.forEach(post => {
                        if (post.tags && Array.isArray(post.tags)) {
                            post.tags.forEach(tag => {
                                if(tag) {
                                   tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                                }
                            });
                        }
                    });
        
                    const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).slice(0, 15);
        
                    if (sortedTags.length > 0) {
                         tagContainer.innerHTML = sortedTags.map(([tag, count]) => {
                            const isActive = currentTag === tag;
                            return `<a href="#" onclick="event.preventDefault(); showTagPosts('${escapeHtml(tag)}');" class="filter-chip ${isActive ? 'active' : ''}" style="text-decoration: none; line-height: 1.5; background: #f5f5f5; border-color: #eee;">
                                #${escapeHtml(tag)} <span style="color: #999; font-size: 12px; margin-left: 4px;">${count}</span>
                             </a>`
                         }).join('');
                        tagCloudContainer.style.display = 'block';
                    } else {
                        tagCloudContainer.style.display = 'none';
                    }
                }
        
                function handleSearch() {
                    currentPage = 1;
                    loadPosts();
                }
        
                function openDeleteModal() {
                    document.getElementById('deleteConfirmModal').classList.add('active');
                }
        
                function closeDeleteModal() {
                    document.getElementById('deleteConfirmModal').classList.remove('active');
                    document.getElementById('deletePassword').value = '';
                }
        
                function openEditModal() {
                    document.getElementById('editConfirmModal').classList.add('active');
                }
        
                function closeEditModal() {
                    document.getElementById('editConfirmModal').classList.remove('active');
                    document.getElementById('editPassword').value = '';
                }
        
                async function handleEditAuth() {
                    const enteredPassword = document.getElementById('editPassword').value;
                    if (!enteredPassword) {
                        showMessage('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    try {
                        const post = await getBin(currentPostId);
                        if (!post) {
                            showMessage('ì˜¤ë¥˜', 'ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }
                        if (post.password !== enteredPassword) {
                            showMessage('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                            return;
                        }
                        closeEditModal();
                        openPostForEditing(post);
                    } catch (error) {
                        console.error('Error authenticating for edit:', error);
                        showMessage('ì˜¤ë¥˜', 'ì¸ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }
        
                function openPostForEditing(post) {
                    editModePostId = post.postId;
                    document.getElementById('postModalTitle').textContent = 'ê²Œì‹œê¸€ ìˆ˜ì •';
                    document.getElementById('postTitle').value = post.title;
                    document.getElementById('postContent').value = post.content;
                    document.getElementById('postCategory').value = post.category;
                    document.getElementById('postTags').value = post.tags ? post.tags.join(', ') : '';
                    document.getElementById('postLink').value = post.link || '';
                    document.getElementById('postPassword').value = post.password;
                    
                    // Handle images if they exist
                    selectedImages = post.images || [];
                    refreshImagePreview();
        
                    document.getElementById('newPostModal').classList.add('active');
                }
        
                async function handleUpdatePost() {
                    const title = document.getElementById('postTitle').value.trim();
                    const content = document.getElementById('postContent').value.trim();
                    const category = document.getElementById('postCategory').value;
                    const tags = document.getElementById('postTags').value.trim().split(',').map(tag => tag.trim()).filter(tag => tag);
                    const link = document.getElementById('postLink').value.trim();
                    const password = document.getElementById('postPassword').value;
        
                    if (!title || !content || !category || !password) {
                        showMessage('ì˜¤ë¥˜', 'ì¹´í…Œê³ ë¦¬, ì œëª©, ë‚´ìš©, ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.');
                        return;
                    }
        
                    try {
                        const postData = await getBin(editModePostId);
                        if (!postData) {
                             showMessage('ì˜¤ë¥˜', 'ìˆ˜ì •í•  ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                             return;
                        }
        
                        postData.title = title;
                        postData.content = content;
                        postData.category = category;
                        postData.tags = tags;
                        postData.link = link;
                        postData.password = password;
                        postData.images = selectedImages;
                        postData.updatedAt = new Date().toISOString();
                        
                        await updateBin(editModePostId, postData);
                        
                        const masterBinId = await getOrCreateIndexBin();
                        const indexData = await getBin(masterBinId);
                        if (indexData && indexData.posts) {
                            const postMetadataIndex = indexData.posts.findIndex(p => p.postId === editModePostId);
                            if (postMetadataIndex !== -1) {
                                indexData.posts[postMetadataIndex].title = postData.title;
                                indexData.posts[postMetadataIndex].category = postData.category;
                                indexData.posts[postMetadataIndex].tags = postData.tags;
                                indexData.posts[postMetadataIndex].contentPreview = postData.content.substring(0, 150);
                                indexData.posts[postMetadataIndex].updatedAt = postData.updatedAt;
                                
                                await updateBin(masterBinId, indexData);
                            }
                        }
        
                        showMessage('ì„±ê³µ', 'ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        closeNewPostModal();
                        viewPost(editModePostId);
                    } catch (error) {
                        console.error('Error updating post:', error);
                        showMessage('ì˜¤ë¥˜', 'ê²Œì‹œê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                }
        
                function setSortOrder(order) {
                    currentPage = 1;
                    currentSortOrder = order;
                    document.querySelectorAll('.action-bar .filter-chip').forEach(chip => chip.classList.remove('active'));
                    
                    let button;
                    if (order === 'latest') button = document.querySelector('.action-bar .filter-chip[onclick*="latest"]');
                    if (order === 'popular') button = document.querySelector('.action-bar .filter-chip[onclick*="popular"]');
                    if (order === 'comments') button = document.querySelector('.action-bar .filter-chip[onclick*="comments"]');
                    if(button) button.classList.add('active');
        
                    loadPosts();
                }
                
                function openDeleteAnswerModal(answerId) {
                    currentAnswerIdToDelete = answerId;
                    document.getElementById('deleteAnswerConfirmModal').classList.add('active');
                }
        
                function closeDeleteAnswerModal() {
                    document.getElementById('deleteAnswerConfirmModal').classList.remove('active');
                    document.getElementById('deleteAnswerPassword').value = '';
                    currentAnswerIdToDelete = null;
                }
        
                function openDeleteReplyModal(replyId, parentAnswerId) {
                    currentReplyIdToDelete = replyId;
                    currentReplyParentId = parentAnswerId; // We need this to find the reply
                    document.getElementById('deleteReplyConfirmModal').classList.add('active');
                }
        
                function closeDeleteReplyModal() {
                    document.getElementById('deleteReplyConfirmModal').classList.remove('active');
                    document.getElementById('deleteReplyPassword').value = '';
                    currentReplyIdToDelete = null;
                    currentReplyParentId = null;
                }
        
                function openReplyForm(answerId) {
                            // Hide the currently open form if there is one
                            if (activeReplyFormId && activeReplyFormId !== answerId) {
                                const oldForm = document.getElementById(`reply-form-${activeReplyFormId}`);
                                if (oldForm) oldForm.style.display = 'none';
                            }
                
                            const form = document.getElementById(`reply-form-${answerId}`);
                            if (!form) return;
                
                            const isVisible = form.style.display === 'block';
                            form.style.display = isVisible ? 'none' : 'block';
                            
                            activeReplyFormId = isVisible ? null : answerId;
                        }        
                async function handleDeleteAnswer() {
                    const enteredPassword = document.getElementById('deleteAnswerPassword').value;
                    if (!enteredPassword) {
                        showMessage('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    if (!currentPostId || !currentAnswerIdToDelete) return;
        
                    try {
                        const post = await getBin(currentPostId);
                        if (!post) throw new Error('Post not found');
        
                        const findAndRemove = (answers, id) => {
                            const answerIndex = answers.findIndex(a => a.answerId === id);
                            if (answerIndex !== -1) {
                                if (answers[answerIndex].password !== enteredPassword) {
                                    showMessage('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                                    return false;
                                }
                                answers.splice(answerIndex, 1);
                                return true;
                            }
                            for (const answer of answers) {
                                if (answer.replies && findAndRemove(answer.replies, id)) {
                                     answer.replyCount = answer.replies.length;
                                     return true;
                                }
                            }
                            return false;
                        };
        
                        if (findAndRemove(post.answers, currentAnswerIdToDelete)) {
                            post.answerCount = post.answers.length; // Recalculate top-level answers
                            
                            await updateBin(currentPostId, post);
        
                            const masterBinId = await getOrCreateIndexBin();
                            const indexData = await getBin(masterBinId);
                            const postMetadata = indexData.posts.find(p => p.postId === currentPostId);
                            if (postMetadata) {
                                postMetadata.answerCount = post.answerCount;
                                await updateBin(masterBinId, indexData);
                            }
        
                            showMessage('ì„±ê³µ', 'ë‹µë³€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            closeDeleteAnswerModal();
                            viewPost(currentPostId);
                        } else {
                            // Message is shown inside findAndRemove
                        }
                    } catch (error) {
                        console.error('Error deleting answer:', error);
                        showMessage('ì˜¤ë¥˜', 'ë‹µë³€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }
                
                async function submitReply(parentAnswerId) {
            const content = document.getElementById(`replyContent_${parentAnswerId}`).value.trim();
            const password = document.getElementById(`replyPassword_${parentAnswerId}`).value;
            const isAnonymous = document.getElementById(`replyAnonymous_${parentAnswerId}`).checked;
            const submitButton = document.getElementById(`submitReplyBtn_${parentAnswerId}`);

            if (!content) {
                showMessage('ì˜¤ë¥˜', 'ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!password) {
                showMessage('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            submitButton.textContent = 'ë“±ë¡ ì¤‘...';
            submitButton.disabled = true;

            try {
                const post = await getBin(currentPostId);
                if (!post) throw new Error('Post not found');

                const findAndAddReply = (answers, targetId) => {
                    for (const answer of answers) {
                        if (answer.answerId === targetId) {
                            const reply = {
                                answerId: generateUUID(),
                                authorName: isAnonymous ? generateAnonymousName() : (localStorage.getItem('anonymous_user_id') || 'ìµëª…'),
                                content,
                                password,
                                likes: 0,
                                replies: [],
                                createdAt: new Date().toISOString()
                            };
                            if (!answer.replies) answer.replies = [];
                            answer.replies.push(reply);
                            answer.replyCount = answer.replies.length;
                            return true;
                        }
                        if (answer.replies && findAndAddReply(answer.replies, targetId)) return true;
                    }
                    return false;
                };

                if (findAndAddReply(post.answers, parentAnswerId)) {
                    await updateBin(currentPostId, post);
                    refreshAnswersView(); 
                } else {
                    showMessage('ì˜¤ë¥˜', 'ìƒìœ„ ë‹µë³€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error submitting reply:', error);
                showMessage('ì˜¤ë¥˜', 'ë‹µê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                submitButton.textContent = 'ë“±ë¡';
                submitButton.disabled = false;
            }
        }

        async function refreshAnswersView() {
            try {
                const post = await getBin(currentPostId);
                if (post) {
                    loadAnswers(post.answers || []);
                }
            } catch (error) {
                console.error("Error refreshing answers view:", error);
            }
        }
        
                async function handleDeleteReply() {
                    const enteredPassword = document.getElementById('deleteReplyPassword').value;
                     if (!enteredPassword) {
                        showMessage('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    if (!currentPostId || !currentReplyIdToDelete) return;
        
                    try {
                        const post = await getBin(currentPostId);
                        if (!post) throw new Error('Post not found');
        
                        const findAndRemove = (answers, id) => {
                            for (const answer of answers) {
                                const replyIndex = (answer.replies || []).findIndex(r => r.answerId === id);
                                if (replyIndex !== -1) {
                                    if (answer.replies[replyIndex].password !== enteredPassword) {
                                        showMessage('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                                        return false;
                                    }
                                    answer.replies.splice(replyIndex, 1);
                                    answer.replyCount = answer.replies.length;
                                    return true;
                                }
                                 if (answer.replies && findAndRemove(answer.replies, id)) return true;
                            }
                            return false;
                        };
        
                        if (findAndRemove(post.answers, currentReplyIdToDelete)) {
                            await updateBin(currentPostId, post);
                            showMessage('ì„±ê³µ', 'ëŒ€ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            closeDeleteReplyModal();
                            viewPost(currentPostId);
                        } else {
                             // Message shown in findAndRemove
                        }
                    } catch (error) {
                        console.error('Error deleting reply:', error);
                        showMessage('ì˜¤ë¥˜', 'ëŒ€ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }
        
                async function handleDeletePost() {
                    const enteredPassword = document.getElementById('deletePassword').value;
                    if (!enteredPassword) {
                        showMessage('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
        
                    try {
                        const post = await getBin(currentPostId);
                        if (!post) {
                            showMessage('ì˜¤ë¥˜', 'ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            closeDeleteModal();
                            return;
                        }
        
                        if (post.password !== enteredPassword) {
                            showMessage('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                            return;
                        }
        
                        const masterBinId = await getOrCreateIndexBin();
                        const indexData = await getBin(masterBinId);
                        if (!indexData || !indexData.posts) {
                             throw new Error("Master index not found or invalid.");
                        }
        
                        const postIndex = indexData.posts.findIndex(p => p.postId === currentPostId);
                        if (postIndex > -1) {
                            indexData.posts.splice(postIndex, 1);
                        }
        
                        const success = await updateBin(masterBinId, indexData);
                        
                        if (success) {
                            // We don't delete the actual post bin, just remove from index.
                            // If you have a server-side component, you could delete it there.
                            closeDeleteModal();
                            showMessage('ì„±ê³µ', 'ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            showAllPosts();
                        } else {
                            showMessage('ì˜¤ë¥˜', 'ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    } catch (error) {
                        console.error('Error deleting post:', error);
                        showMessage('ì˜¤ë¥˜', 'ê²Œì‹œê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }
        
        function openNewPostModal() {
            editModePostId = null;
            document.getElementById('postModalTitle').textContent = 'ìƒˆ ê¸€ ì‘ì„±';
            document.getElementById('newPostModal').classList.add('active');
        }

        function closeNewPostModal() {
            document.getElementById('newPostModal').classList.remove('active');
            editModePostId = null;
            // Reset form fields
            document.getElementById('postForm').reset(); // Use form reset for simplicity
            selectedImages = [];
            document.getElementById('imagePreview').innerHTML = '';
        }

        function handleImageSelect(event) {
            const files = event.target.files;
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const MAX_WIDTH = 1024;
                            const MAX_HEIGHT = 1024;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                            selectedImages.push(compressedBase64);
                            refreshImagePreview();
                        }
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function handlePasteImages(event) {
            if (!event.clipboardData || !event.clipboardData.items) return;
            const items = event.clipboardData.items;
            let hasImage = false;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    hasImage = true;
                    const file = item.getAsFile();
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = new Image();
                            img.onload = function() {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const MAX_WIDTH = 1024;
                                const MAX_HEIGHT = 1024;
                                let width = img.width;
                                let height = img.height;

                                if (width > height) {
                                    if (width > MAX_WIDTH) {
                                        height *= MAX_WIDTH / width;
                                        width = MAX_WIDTH;
                                    }
                                } else {
                                    if (height > MAX_HEIGHT) {
                                        width *= MAX_HEIGHT / height;
                                        height = MAX_HEIGHT;
                                    }
                                }
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                                const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                                selectedImages.push(compressedBase64);
                                refreshImagePreview();
                            }
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }
            if (hasImage) {
                event.preventDefault();
            }
        }

        function refreshImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = selectedImages.map(img => `
                <div style="position: relative; aspect-ratio: 1;">
                    <img src="${img}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                </div>
            `).join('');
        }

        async function submitPost() {
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            const category = document.getElementById('postCategory').value;
            const password = document.getElementById('postPassword').value;

            // More specific validation
            if (!category) {
                showMessage('ì˜¤ë¥˜', 'ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!title) {
                showMessage('ì˜¤ë¥˜', 'ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!content) {
                showMessage('ì˜¤ë¥˜', 'ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!password) {
                showMessage('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const tags = document.getElementById('postTags').value.trim().split(',').map(tag => tag.trim()).filter(tag => tag);
            const link = document.getElementById('postLink').value.trim();
            const isAnonymous = document.getElementById('postAnonymous').checked;
            
            document.querySelector('#newPostModal button[type="submit"]').textContent = 'ë“±ë¡ ì¤‘...';
            document.querySelector('#newPostModal button[type="submit"]').disabled = true;

            const userId = getUserId();
            const postData = {
                postId: '',
                authorId: isAnonymous ? null : userId,
                authorName: isAnonymous ? generateAnonymousName() : userId,
                title: title,
                content: content,
                category: category,
                tags: tags,
                link: link,
                password: password,
                images: selectedImages,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                likes: 0,
                views: 0,
                answerCount: 0,
                answers: []
            };

            try {
                // Use a UUID for the bin name to avoid character set issues in HTTP headers
                const newPostId = await createBin(postData, `Post - ${generateUUID()}`);
                if (!newPostId) {
                    throw new Error("Failed to create post bin.");
                }
                postData.postId = newPostId;

                await updateBin(newPostId, postData);

                const masterBinId = await getOrCreateIndexBin();
                let indexData = await getBin(masterBinId);
                
                if (!indexData || !Array.isArray(indexData.posts)) {
                    indexData = { posts: [] };
                }
                
                const postMetadata = {
                    postId: newPostId,
                    title: postData.title,
                    authorName: postData.authorName,
                    category: postData.category,
                    createdAt: postData.createdAt,
                    updatedAt: postData.updatedAt,
                    answerCount: 0,
                    views: 0,
                    likes: 0,
                    tags: postData.tags,
                    contentPreview: postData.content.substring(0, 150)
                };
                
                indexData.posts.unshift(postMetadata);
                await updateBin(masterBinId, indexData);

                closeNewPostModal();
                loadPosts();
                showMessage('ì„±ê³µ', 'ê²Œì‹œê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');

            } catch (error) {
                console.error('Error submitting post:', error);
                showMessage('ì˜¤ë¥˜', `ê²Œì‹œê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${error.message})`);
            } finally {
                document.querySelector('#newPostModal button[type="submit"]').textContent = 'ê²Œì‹œê¸€ ë“±ë¡';
                document.querySelector('#newPostModal button[type="submit"]').disabled = false;
            }
        }
        
        async function viewPost(postId) {
            currentPostId = postId;
            document.getElementById('loading').classList.add('active');
            document.getElementById('postsContainer').style.display = 'none';
            document.getElementById('postDetail').style.display = 'none';
            document.getElementById('actionBar').style.display = 'none';
            document.getElementById('mainHeader').style.display = 'none';
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('featuredPostsSection').style.display = 'none';

            try {
                const masterBinId = await getOrCreateIndexBin();
                const indexData = await getBin(masterBinId);
                if (!indexData || !indexData.posts) throw new Error("Master index not found or invalid.");
                
                const postMetadata = indexData.posts.find(p => p.postId === postId);
                const post = await getBin(postId);

                if (!post || !postMetadata) {
                    throw new Error('Post not found');
                }

                // Increment view count
                postMetadata.views = (postMetadata.views || 0) + 1;
                await updateBin(masterBinId, indexData);

                // Display post
                document.getElementById('detailTitle').textContent = post.title;

                let metaHtml = `
                    <span class="post-category">${escapeHtml(post.category)}</span>
                    <span class="stat-item" style="color: #999;">ğŸ‘ï¸ ${postMetadata.views}</span>
                    <span class="stat-item" style="color: var(--primary-color); font-weight: 600;">â¤ï¸ ${postMetadata.likes || 0}</span>
                    <span class="stat-item" style="color: var(--secondary-color); font-weight: 600;">ğŸ’¬ ${postMetadata.answerCount || 0}</span>
                `;
                document.getElementById('detailMeta').innerHTML = metaHtml;
                
                let contentHtml = escapeHtml(post.content).replace(/\n/g, '<br>');

                // YouTube Embed
                const videoId = getYouTubeVideoId(post.link);
                if (videoId) {
                    contentHtml += `
                        <div style="margin-top:20px; position:relative; padding-bottom:56.25%; height:0; overflow:hidden;">
                            <iframe src="https://www.youtube.com/embed/${videoId}" 
                                style="position:absolute; top:0; left:0; width:100%; height:100%;" 
                                frameborder="0" allowfullscreen></iframe>
                        </div>
                    `;
                } else if (post.link) {
                     contentHtml += `<br><br><a href="${escapeHtml(post.link)}" target="_blank" style="color: var(--primary-color);">ì°¸ê³  ë§í¬: ${escapeHtml(post.link)}</a>`;
                }

                // Image display
                if (post.images && post.images.length > 0) {
                    contentHtml += '<div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">';
                    post.images.forEach(img => {
                        contentHtml += `<a href="${img}" target="_blank"><img src="${img}" style="width: 100%; border-radius: 8px; border: 1px solid #eee;"></a>`;
                    });
                    contentHtml += '</div>';
                }

                document.getElementById('detailContent').innerHTML = contentHtml;
                
                // Footer
                const isLikedByMe = isLiked(postId);
                const postFooter = document.querySelector('#postDetail .post-footer');
                postFooter.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="post-author">${escapeHtml(post.authorName || 'ìµëª…')}</span>
                        <span style="color: #999; font-size: 13px;">${formatDate(post.createdAt)}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div class="like-section" style="display: flex; align-items: center; gap: 5px;">
                            <button class="btn-like" onclick="handleLike('${postId}', 'post')" style="background: none; border: none; cursor: pointer; font-size: 24px; padding: 0; color: ${isLikedByMe ? 'var(--primary-color)' : '#ccc'};">
                                ${isLikedByMe ? 'â¤ï¸' : 'ğŸ¤'}
                            </button>
                            <span class="like-count" style="font-size: 16px; color: #555; font-weight: 600;">${postMetadata.likes || 0}</span>
                        </div>
                        <div id="postActions"></div>
                    </div>
                `;
                
                // Action buttons
                let actionsHtml = '';
                const shareUrl = `${window.location.origin}${window.location.pathname}?postId=${postId}`;
                actionsHtml += `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="copyToClipboard('${shareUrl}')">ê³µìœ </button>`;
                
                if (post.password) {
                     actionsHtml += `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" onclick="openEditModal()">ìˆ˜ì •</button>`;
                     actionsHtml += `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px; color: #ff4d4d;" onclick="openDeleteModal()">ì‚­ì œ</button>`;
                }
                document.getElementById('postActions').innerHTML = actionsHtml;

                // Load answers
                document.getElementById('answerCountDisplay').textContent = post.answers ? post.answers.length : 0;
                loadAnswers(post.answers || []);

                document.getElementById('postDetail').style.display = 'block';

            } catch (error) {
                console.error('Error viewing post:', error);
                showMessage('ì˜¤ë¥˜', 'ê²Œì‹œë¬¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                showAllPosts();
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }
        
        function loadAnswers(answers) {
            const container = document.getElementById('answersList');
            if (!answers || answers.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#999; padding:40px 0; border: 1px dashed #ddd; border-radius: 12px;">ì•„ì§ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            container.innerHTML = answers.map(ans => renderAnswer(ans)).join('');
        }

                function renderAnswer(answer, level = 0, parentAuthorName = '') {
            const isLikedByMe = isLiked(answer.answerId);
            let replyIndicator = level > 0 ? `<div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">â†ªï¸ <span style="font-weight: 600;">${escapeHtml(parentAuthorName)}</span>ë‹˜ì—ê²Œ</div>` : '';
            
            const replyFormHtml = `
                <div id="reply-form-${answer.answerId}" class="reply-form" style="display: none; background: #f0f0f0; padding: 15px; border-radius: 10px; margin-top: 10px;">
                    <textarea id="replyContent_${answer.answerId}" class="form-textarea" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="3" style="min-height: 70px; background: white; margin-bottom: 8px;"></textarea>
                    <div class="form-group" style="margin-bottom: 8px;">
                        <label class="form-label" style="font-size: 13px; font-weight: normal;">ë¹„ë°€ë²ˆí˜¸ (í•„ìˆ˜)</label>
                        <input type="password" id="replyPassword_${answer.answerId}" class="form-input" style="padding: 8px;" placeholder="ë‹µê¸€ ìˆ˜ì •/ì‚­ì œ ì‹œ í•„ìš”í•©ë‹ˆë‹¤">
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="replyAnonymous_${answer.answerId}" style="width: 14px; height: 14px;">
                            <label for="replyAnonymous_${answer.answerId}" style="font-size: 13px; cursor: pointer;">ìµëª…</label>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary" style="font-size: 13px; padding: 6px 12px;" onclick="openReplyForm('${answer.answerId}')">ì·¨ì†Œ</button>
                            <button type="button" id="submitReplyBtn_${answer.answerId}" class="btn btn-primary" style="font-size: 13px; padding: 6px 12px; margin-left: 8px;" onclick="submitReply('${answer.answerId}')">ë“±ë¡</button>
                        </div>
                    </div>
                </div>
            `;

            return `
                <div class="answer-card" style="margin-left: ${level * 25}px; padding: 20px; background: ${level > 0 ? '#fafafa' : '#f8f9fa'}; border-radius: 16px; border-top: 1px solid #eee;">
                     <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="author-avatar" style="width: 28px; height: 28px;"></div>
                            <span style="font-weight:600; color:var(--text-main);">${escapeHtml(answer.authorName)}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; font-size: 13px;">
                            <span style="color:#999;">${formatDate(answer.createdAt)}</span>
                            ${answer.password ? `<button onclick="openDeleteAnswerModal('${answer.answerId}')" style="background: none; border: none; color: #aaa; cursor: pointer;">ì‚­ì œ</button>` : ''}
                        </div>
                    </div>
                    ${replyIndicator}
                    <div style="line-height:1.7; color: #444; margin-bottom: 12px;">${escapeHtml(answer.content).replace(/\n/g, '<br>')}</div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="like-section" style="display: flex; align-items: center; gap: 5px;">
                            <button class="btn-like" onclick="handleLike('${answer.answerId}', 'answer')" style="background: none; border: none; cursor: pointer; font-size: 18px; padding: 0; color: ${isLikedByMe ? 'var(--primary-color)' : '#ccc'};">
                                ${isLikedByMe ? 'â¤ï¸' : 'ğŸ¤'}
                            </button>
                            <span class="like-count" style="font-size: 13px; color: #555; font-weight: 600;">${answer.likes || 0}</span>
                        </div>
                        <button onclick="openReplyForm('${answer.answerId}')" class="btn btn-secondary" style="font-size: 13px; padding: 4px 10px;">
                            ë‹µê¸€ (${answer.replies ? answer.replies.length : 0})
                        </button>
                    </div>
                    ${replyFormHtml}
                    ${answer.replies && answer.replies.length > 0 ? `<div style="margin-top: 15px; padding-left: 20px; border-left: 2px solid #eee;">${answer.replies.map(reply => renderAnswer(reply, level + 1, answer.authorName)).join('')}</div>` : ''}
                </div>
            `;
        }
        
        async function submitAnswer() {
            const content = document.getElementById('answerContent').value.trim();
            const password = document.getElementById('answerPassword').value;
            const isAnonymous = document.getElementById('answerAnonymous').checked;
            
            if (!content) {
                showMessage('ì˜¤ë¥˜', 'ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if(!password) {
                 showMessage('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const answer = {
                answerId: generateUUID(),
                authorName: isAnonymous ? generateAnonymousName() : (localStorage.getItem('anonymous_user_id') || 'ìµëª…'),
                content,
                password,
                likes: 0,
                replies: [],
                createdAt: new Date().toISOString()
            };

            document.getElementById('submitAnswerBtn').disabled = true;

            try {
                const post = await getBin(currentPostId);
                if (!post) throw new Error("Post not found");

                if (!post.answers) post.answers = [];
                post.answers.push(answer);
                post.answerCount = post.answers.length;

                await updateBin(currentPostId, post);
                
                const masterBinId = await getOrCreateIndexBin();
                const indexData = await getBin(masterBinId);
                const postMetadata = indexData.posts.find(p => p.postId === currentPostId);
                if (postMetadata) {
                    postMetadata.answerCount = post.answerCount;
                    await updateBin(masterBinId, indexData);
                }

                document.getElementById('answerContent').value = '';
                document.getElementById('answerPassword').value = '';
                viewPost(currentPostId);

            } catch (e) {
                showMessage('ì˜¤ë¥˜', 'ë‹µë³€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            } finally {
                document.getElementById('submitAnswerBtn').disabled = false;
            }
        }

        async function submitReply(parentAnswerId) {
            const content = document.getElementById(`replyContent_${parentAnswerId}`).value.trim();
            const password = document.getElementById(`replyPassword_${parentAnswerId}`).value;
            const isAnonymous = document.getElementById(`replyAnonymous_${parentAnswerId}`).checked;
            const submitButton = document.getElementById(`submitReplyBtn_${parentAnswerId}`);

            if (!content) {
                showMessage('ì˜¤ë¥˜', 'ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!password) {
                showMessage('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            submitButton.textContent = 'ë“±ë¡ ì¤‘...';
            submitButton.disabled = true;

            try {
                const post = await getBin(currentPostId);
                if (!post) throw new Error('Post not found');

                const findAndAddReply = (answers, targetId) => {
                    for (const answer of answers) {
                        if (answer.answerId === targetId) {
                            const reply = {
                                answerId: generateUUID(),
                                authorName: isAnonymous ? generateAnonymousName() : (localStorage.getItem('anonymous_user_id') || 'ìµëª…'),
                                content,
                                password,
                                likes: 0,
                                replies: [],
                                createdAt: new Date().toISOString()
                            };
                            if (!answer.replies) answer.replies = [];
                            answer.replies.push(reply);
                            answer.replyCount = answer.replies.length;
                            return true;
                        }
                        if (answer.replies && findAndAddReply(answer.replies, targetId)) return true;
                    }
                    return false;
                };

                if (findAndAddReply(post.answers, parentAnswerId)) {
                    await updateBin(currentPostId, post);
                    refreshAnswersView(); 
                } else {
                    showMessage('ì˜¤ë¥˜', 'ìƒìœ„ ë‹µë³€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error submitting reply:', error);
                showMessage('ì˜¤ë¥˜', 'ë‹µê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                submitButton.textContent = 'ë“±ë¡';
                submitButton.disabled = false;
            }
        }

        async function refreshAnswersView() {
            try {
                const post = await getBin(currentPostId);
                if (post) {
                    loadAnswers(post.answers || []);
                }
            } catch (error) {
                console.error("Error refreshing answers view:", error);
            }
        }
        
                function showAllPosts() {
            currentPostId = null;
            currentCategory = null;
            currentTag = null;
            currentPage = 1;
            document.getElementById('postDetail').style.display = 'none';
            document.getElementById('postsContainer').style.display = 'flex';
            document.getElementById('actionBar').style.display = 'flex';
            document.getElementById('mainHeader').style.display = 'block';
            document.getElementById('searchContainer').style.display = 'block';
            document.getElementById('topPostsSection').style.display = 'none';
            document.getElementById('featuredPostsSection').style.display = 'block';
            window.history.pushState({}, '', window.location.pathname);
            
            // Update active LNB menu
            document.querySelectorAll('.lnb-menu a').forEach(el => el.classList.remove('active'));
            document.querySelector('.lnb-menu a[onclick*="showAllPosts"]').classList.add('active');

            loadFeaturedPosts();
            loadPosts();
        }
        
        async function showTopPosts() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('postsContainer').style.display = 'none';
            document.getElementById('postDetail').style.display = 'none';
            document.getElementById('actionBar').style.display = 'none';
            document.getElementById('mainHeader').style.display = 'none';
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('topPostsSection').style.display = 'block';
            document.getElementById('featuredPostsSection').style.display = 'none';

            // Update active LNB menu
            document.querySelectorAll('.lnb-menu a').forEach(el => el.classList.remove('active'));
            document.querySelector('.lnb-menu a[onclick*="showTopPosts"]').classList.add('active');

            const grid = document.getElementById('topPostsGrid');
            grid.innerHTML = '';

            try {
                const masterBinId = await getOrCreateIndexBin();
                const indexData = await getBin(masterBinId);
                let allPosts = (indexData && Array.isArray(indexData.posts)) ? indexData.posts : [];

                if (allPosts.length === 0) {
                    grid.innerHTML = `<div class="empty-state">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                    return;
                }

                // Calculate score and sort
                const scoredPosts = allPosts.map(post => {
                    const score = (post.likes || 0) + (post.answerCount || 0) * 2;
                    return { ...post, score };
                });

                scoredPosts.sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    return new Date(b.createdAt) - new Date(a.createdAt); // Tie-breaker
                });

                const topPosts = scoredPosts.slice(0, 10); // Get top 10

                // Render top posts
                grid.innerHTML = topPosts.map((post, index) => {
                    return `
                        <div class="top-post-card" onclick="viewPost('${post.postId}')">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <div style="font-size: 24px; font-weight: 900; color: #ddd;">${index + 1}</div>
                                <div style="flex: 1;">
                                    <div class="post-title" style="font-size: 18px; margin-bottom: 5px;">${escapeHtml(post.title)}</div>
                                    <div class="post-meta" style="font-size: 12px;">
                                        <span class="post-category">${escapeHtml(post.category)}</span>
                                        <span>${formatDate(post.createdAt)}</span>
                                    </div>
                                    <div class="post-stats" style="margin-top: 10px; font-size: 12px; justify-content: flex-start;">
                                        <span class="stat-item" style="color: var(--primary-color);">â¤ï¸ ${post.likes || 0}</span>
                                        <span class="stat-item" style="color: var(--secondary-color);">ğŸ’¬ ${post.answerCount || 0}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error('Error showing top posts:', e);
                grid.innerHTML = `<div class="empty-state">ì¸ê¸° ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }
        
        function showCategoryPosts(category) {
            currentPostId = null;
            currentCategory = category;
            currentTag = null;
            currentPage = 1;

            document.getElementById('postDetail').style.display = 'none';
            document.getElementById('postsContainer').style.display = 'flex';
            document.getElementById('actionBar').style.display = 'flex';
            document.getElementById('mainHeader').style.display = 'block';
            document.getElementById('searchContainer').style.display = 'block';
            document.getElementById('topPostsSection').style.display = 'none';
            document.getElementById('featuredPostsSection').style.display = 'none';
            
            document.querySelectorAll('.lnb-menu a').forEach(el => el.classList.remove('active'));
            document.querySelector(`.lnb-menu a[onclick*="'${category}'"]`).classList.add('active');

            loadPosts();
        }

        function showTagPosts(tag) {
            currentPostId = null;
            currentCategory = null;
            currentTag = tag;
            currentPage = 1;
            
            document.getElementById('postDetail').style.display = 'none';
            document.getElementById('postsContainer').style.display = 'flex';
            document.getElementById('actionBar').style.display = 'flex';
            document.getElementById('mainHeader').style.display = 'block';
            document.getElementById('searchContainer').style.display = 'block';
            document.getElementById('topPostsSection').style.display = 'none';
            document.getElementById('featuredPostsSection').style.display = 'none';

            document.querySelectorAll('.lnb-menu a').forEach(el => el.classList.remove('active'));
            
            loadPosts();
        }

        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const diff = now.getTime() - date.getTime();
            const diffMinutes = Math.floor(diff / (1000 * 60));
            if (diffMinutes < 1) return 'ë°©ê¸ˆ ì „';
            if (diffMinutes < 60) return `${diffMinutes}ë¶„ ì „`;
            const diffHours = Math.floor(diff / (1000 * 60 * 60));
            if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
            return date.toLocaleDateString('ko-KR');
        }

        function showMessage(title, message) {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageContent').textContent = message;
            document.getElementById('messageModal').classList.add('active');
        }

        function closeMessageModal() {
            document.getElementById('messageModal').classList.remove('active');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('ì„±ê³µ', 'ê²Œì‹œê¸€ ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }, () => {
                showMessage('ì˜¤ë¥˜', 'ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        document.addEventListener('DOMContentLoaded', () => {
            init();

            // Iframe Auto Resize using postMessage
            const sendHeight = () => {
                const height = document.documentElement.scrollHeight;
                window.parent.postMessage({ type: 'resize', height: height }, '*');
            };

            const resizeObserver = new ResizeObserver(sendHeight);
            resizeObserver.observe(document.body);
            window.addEventListener('load', sendHeight);
        });
    </script>
</body>
</html>